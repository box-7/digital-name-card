name: CICD

# *** 要注意 firebase.jsonの設定がおかしいとデプロイできない***

on:
  push:
    branches:
      - main
  workflow_dispatch: # GitHub Actions の UI から手動で実行するためのトリガー

  deploy:
    name: deploy
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      # - uses: actions/setup-node@v4  # これを追加 // 追加せずにエラー解決できた firebase.jsonの問題だった
      #   with:
      #     node-version: '20'
      # - name: Install dependencies  # これも追加
      #   run: npm install
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts # buildでアップロードしたアーティファクトの名前
          path: dist
      - name: Deploy to Firebase Hosting
        # uses: FirebaseExtended/action-hosting-deploy@v0
        # with:
        #   # firebaseServiceAccount: "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}"
        #   projectId: "${{ secrets.FIREBASE_PROJECT_ID }}"
        #   # github actionsに自動生成された firebase initで時作成されたと思われる
        #   # 使えないので、コメントアウト
        #   firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_TS_DIGITAL_CARD_NAME }}
        #   channelId: live
        # env:
        #   FIREBASE_CLI_EXPERIMENTS: webframeworks
        # uses: FirebaseExtended/action-hosting-deploy@v0
        # with:
        #   firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
        # env:
        #   FIREBASE_CLI_EXPERIMENTS: webframeworks
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
        # Firebase Admin SDKの秘密鍵を生成
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          projectId: "${{ secrets.FIREBASE_PROJECT_ID }}"  # Firebase プロジェクトID
# ${{ github.sha }}を使用する方がベストプラクティス
# 一意性: 各デプロイが異なるチャンネルIDを持つため、PRやコミットごとに個別のプレビューURLが生成される
# トレーサビリティ: チャンネルIDがコミットハッシュと一致するため、どのコードがデプロイされているか追跡が容易
          channelId: '${{ github.sha }}'
          # entryPoint: '.' // 追加せずにエラー解決できた firebase.jsonの問題だった
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks


# 自動生成されたファイル
# firebase-hosting-merge.yml
# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

# name: Deploy to Firebase Hosting on merge
# on:
#   push:
#     branches:
#       - main
# jobs:
#   build_and_deploy:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v4
#       - run: npm ci
#       - run: npm ci && npm run build
#       - uses: FirebaseExtended/action-hosting-deploy@v0
#         with:
#           repoToken: ${{ secrets.GITHUB_TOKEN }}
#           firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_TS_DIGITAL_CARD_NAME }}
#           channelId: live
#           projectId: ts-digital-card-name
#         env:
#           FIREBASE_CLI_EXPERIMENTS: webframeworks
